name: Daily Article Generator

# ç¾åœ¨ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™ã€‚æœ‰åŠ¹åŒ–ã™ã‚‹ã«ã¯ä¸‹è¨˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’å¤–ã—ã¦ãã ã•ã„ã€‚
on:
    # schedule:
    #     # æ¯æ—¥åˆå‰9æ™‚ï¼ˆJST = UTC+9ï¼‰ã«å®Ÿè¡Œ = UTC 0æ™‚
    #     - cron: '0 0 * * *'
    workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã¯å¯èƒ½

jobs:
    generate-article:
        runs-on: ubuntu-latest
        permissions:
            contents: write
            pull-requests: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '22'
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Generate daily article
              env:
                  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
              run: node scripts/generate-daily-article.js

            - name: Check for changes
              id: check_changes
              run: |
                  if git diff --quiet && git diff --cached --quiet; then
                    echo "has_changes=false" >> $GITHUB_OUTPUT
                    echo "æœ¬æ—¥ã®è¨˜äº‹ã¯æ—¢ã«å­˜åœ¨ã™ã‚‹ã‹ã€ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚"
                  else
                    echo "has_changes=true" >> $GITHUB_OUTPUT
                    echo "æ–°ã—ã„è¨˜äº‹ãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚"
                  fi

            - name: Create Pull Request
              if: steps.check_changes.outputs.has_changes == 'true'
              uses: peter-evans/create-pull-request@v6
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  commit-message: 'Add daily tech article for ${{ github.event.repository.updated_at }}'
                  committer: GitHub Actions <actions@github.com>
                  author: GitHub Actions <actions@github.com>
                  branch: daily-article/${{ github.run_id }}
                  delete-branch: true
                  title: 'ğŸ“ Daily Tech Article - ${{ github.event.repository.updated_at }}'
                  body: |
                      ## è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸè¨˜äº‹

                      ã“ã®PRã¯ã€GitHub Actionsã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸæŠ€è¡“è¨˜äº‹ã‚’å«ã‚“ã§ã„ã¾ã™ã€‚

                      ### ç¢ºèªäº‹é …
                      - [ ] è¨˜äº‹ã®å†…å®¹ãŒé©åˆ‡ã‹ç¢ºèª
                      - [ ] æ–‡æ³•ã‚„è¡¨ç¾ã«å•é¡ŒãŒãªã„ã‹ç¢ºèª
                      - [ ] ãƒªãƒ³ã‚¯ã‚„ç”»åƒãŒæ­£ã—ãæ©Ÿèƒ½ã™ã‚‹ã‹ç¢ºèª
                      - [ ] æŠ€è¡“çš„ãªæƒ…å ±ãŒæ­£ç¢ºã‹ç¢ºèª

                      ### è¨˜äº‹ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾Œ
                      å•é¡ŒãŒãªã‘ã‚Œã°ã€ã“ã®PRã‚’ãƒãƒ¼ã‚¸ã—ã¦ãã ã•ã„ã€‚
                      ãƒãƒ¼ã‚¸å¾Œã€Netlifyã§è‡ªå‹•çš„ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã™ã€‚

                      ---
                      ğŸ¤– Generated with AI using OpenAI GPT-4
                  labels: |
                      automated
                      content
                      article
                  assignees: takafumikobayashi
                  reviewers: takafumikobayashi

            - name: PR creation result
              if: steps.check_changes.outputs.has_changes == 'true'
              run: echo "PRãŒä½œæˆã•ã‚Œã¾ã—ãŸã€‚è¨˜äº‹ã‚’ç¢ºèªã—ã¦ãƒãƒ¼ã‚¸ã—ã¦ãã ã•ã„ã€‚"

            - name: No changes detected
              if: steps.check_changes.outputs.has_changes == 'false'
              run: echo "å¤‰æ›´ãŒãªã„ãŸã‚ã€PRã¯ä½œæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚"
